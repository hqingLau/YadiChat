<!DOCTYPE HTML>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>å…¨å±€èŠå¤©å®¤</title>
    <!-- å¼•å…¥ Bootstrap -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/fontawesome.min.css">
    <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.js"></script>
    <style type="text/css">
        body{ padding-bottom:80px;
            max-width: 1000px;
            margin: 0 auto;
        }
        .fixed{
            max-width: 800px;
            margin: 0 auto;
            position: fixed;
            bottom: 0px;
            width: 100%;
            height: 50px;
            /*background-color: #000;*/
            background-color: white;
            z-index: 9999;
        }
        .msg {
            margin-left: 30px;
            margin-right: 30px;
            margin-top: 8px;
            max-width: 500px;
        }
        .nickname {
            background: #31708f;
            color: white;
            border-radius: 10px;
            padding: 8px;
        }
        ul {
            overflow: auto;
            height: auto;
            margin: 0 auto;
        }

        li {
            float: left;
            width: 100%;
            margin: 0 auto;
        }

        .haha {
            background: #00bfff1c;
            border-radius: 5px;
            padding: 10px;
            width: fit-content;
            margin-top: 5px;
        }
        ::-webkit-scrollbar {

            width: 5px;

            height: 2px;
        }
        ::-webkit-scrollbar-thumb {
            background:linear-gradient(to right, #ccc 0%, #ccc 100%);
            width: 85%

        }

        ::-webkit-scrollbar-track {
            background-color: transparent
        }
        span {
            word-break: break-all;
        }





    </style>
</head>
<body>
<div class="page-header text-center text-primary">
    <h1>èŠå¤©å®¤</h1>
    <div id="cur_room_id">æˆ¿é—´id:global_room_msg</div>
</div>

<br /><br />
<!--<div id="message"></div>-->
<div style="float:left">
    <ul class="list-group" id="belong_group" style="overflow-y: scroll; width: 170px; height: 74vh ;background: lightgray">
        <li  class="list-group-item"><button class="btn btn-inverse"><a href="/new-room">æ–°å»ºæˆ¿é—´</a> </button></li>
        <li  class="list-group-item"><button class="btn btn-inverse"><a href="/join-room">åŠ å…¥æˆ¿é—´</a> </button></li>
        <li  class="list-group-item"><button class="group-btn btn btn-inverse" onclick="reenter(this.id)"  id="global_room_msg">å…¨å±€æˆ¿é—´</button> </li>
    </ul>
</div>

<div style="height: 61vh;background: whitesmoke">
<ul class="list-group" id="message" style="overflow-y: scroll; max-height: 60vh">
    <li class="list-group-item"><span class="nickname">ç³»ç»Ÿä¿¡æ¯</span><div class="msg"> <img style="max-width: 350px; max-height: 250px"  src="../static/Inked1f458c3644db4f1db12c16772edce24cæ— æ ‡é¢˜_LI.jpg"></div></li>
    <!--<li class="list-group-item">-->
    <!--    <div style="float: right">-->
    <!--        <span class="nickname">dsafffffffffffffffffffffffffff</span>-->
    <!--    </div>-->
    <!--    <br />-->
    <!--    <div class="msg" style="float: right"> æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤-->
    <!--            æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤-->
    <!--            æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤-->
    <!--            æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤-->
    <!--            æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤-->
    <!--            æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤-->
    <!--            æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤ æ¬¢è¿å…¥ç¾¤-->
    <!--    </div>-->

    <!--</li>-->

</ul>
</div>
<div class="clear:both"></div>

<div class="">
    <button class="btn btn-primary" style="float: right;margin-right: 10px;margin-top: 33px" type="button" onclick="send()">å‘é€</button>

    <div style="overflow: hidden; padding-right: 10px">
        <div style="padding-left:10px; float: left;"><input type="file" id="d3" onchange="fileChange(this);"></div>
        <button class="btn btn-mini" style="float: right;" id="d4">æ–‡ä»¶ä¸Šä¼ </button>
    <textarea style="margin-left:10px;width: 100%; resize: none;height: 10vh"
           id="text"
           name="send"
           placeholder="è¾“å…¥å‘é€æ¶ˆæ¯"
           maxlength="1000"
           minlength="1"
           class="form-control"></textarea>
    </div>

    <div class="clear"></div>
</div>

<script>
    function fileChange(target) {
        var fileSize = 0;
        fileSize = target.files[0].size;
        var size = fileSize / 1024;
        if(size>10000){
            alert("ä½ å¥½ï¼Œæˆ‘æœåŠ¡å™¨å¤ªèœï¼Œæ–‡ä»¶æœ€å¥½ä¸è¦å¤§äº10M");
            target.value="";
            return false;   //é˜»æ­¢submitæäº¤
        }
    }
    //ç‚¹å‡»æŒ‰é’®æœåç«¯å‘é€æ™®é€šé”®å€¼å¯¹å’Œæ–‡ä»¶æ•°æ®
    $('#d4').on('click',function (){
        //1.éœ€è¦å…ˆåˆ©ç”¨FormDataå†…ç½®å¯¹è±¡
        let formDataObj = new FormData();

        //3.æ·»åŠ æ–‡ä»¶å¯¹è±¡
        formDataObj.append('file',$('#d3')[0].files[0])
        //4.å°†å¯¹è±¡åŸºäºajaxå‘é€ç»™åç«¯
        $.ajax({
            url:'/yadiUploadFile',
            type:'post',
            data:formDataObj,  //ç›´æ¥å°†å¯¹è±¡æ”¾åœ¨dataåé¢

            //ajaxå‘é€æ–‡ä»¶å¿…é¡»è¦æŒ‡å®šä¸¤ä¸ªå‚æ•°
            contentType:false,  //ä¸è¦ä½¿ç”¨ä»»ä½•ç¼–ç ï¼Œdjangoåç«¯èƒ½å¤Ÿè‡ªåŠ¨è¯†åˆ«formdataå¯¹è±¡
            processData:false,  //å‘Šè¯‰æµè§ˆå™¨ä¸è¦å¯¹ä½ çš„æ•°æ®è¿›è¡Œä»»ä½•å¤„ç†

            success:function (data) {
                //è½¬æ¢jsonå­—ç¬¦ä¸²ä¸ºjsonå¯¹è±¡
                //æ–¹å¼ä¸€ï¼š
                console.log(data);
                var obj2 = data;
                var obj = document.getElementById('d3') ;
                obj.outerHTML=obj.outerHTML;
                //è½¬ä¸ºjsonå¯¹è±¡å¯ä»¥ç›´æ¥ç‚¹å±æ€§


                var map = new Map();
                if(obj2.status=="false") {
                    return;
                }
                map.set("type",obj2.type);
                map.set("user",getCookie("user"));
                map.set("group",globalGroup);
                map.set("msg",obj2.origin_name);
                map.set("url",obj2.file_url);
                var map2json=Map2Json(map);
                webSocket.send(map2json);
            }
        })

    })
</script>
<script type="text/javascript">
    var webSocket;
    var MAGIC_FILE_SPLIT="rrutg@%&$^%@$nv.,xgjqer";
    var MAGIC_IMAGE_SPLIT="%@^$%&afdgw%^@$^@asqdf";
    var globalGroup='global_room_msg';
    var loadPreMsg = false;
    var wsConnect = false; //é¿å…é‡å¤è¿æ¥
    var url = "ws://ws-yadichat.orzlinux.cn/ws";
    // var url = "ws://localhost:10240/ws";
    if (window.WebSocket) {
        webSocket = new WebSocket(url);
    } else {
        alert("æŠ±æ­‰ï¼Œæ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒWebSocketåè®®!");
    }
    $(function(){

        function ping() {
            if(wsConnect===true) {
                console.log("ping...");
                webSocket.send("heartbeat");
            }
        }
        setInterval(ping, 5000);
    })
    function setWebSocket() {
        //è¿é€šä¹‹åçš„å›è°ƒäº‹ä»¶
        webSocket.onopen = function() {
            console.log("å·²ç»è¿é€šäº†websocket");
            wsConnect = true;
            enter();
        }
        //è¿æ¥å‘ç”Ÿé”™è¯¯çš„å›è°ƒæ–¹æ³•
        webSocket.onerror = function(event){
            console.log("å‡ºé”™äº†");
            wsConnect = false;
            reconnect(url);
//              setMessageInnerHTML("è¿æ¥å¤±è´¥");
        };

        //è¿æ¥å…³é—­çš„å›è°ƒæ–¹æ³•
        webSocket.onclose = function(){
            console.log("è¿æ¥å·²å…³é—­...");
            wsConnect = false;
            reconnect(url);
        }

        //æ¥æ”¶åˆ°æ¶ˆæ¯çš„å›è°ƒæ–¹æ³•
        webSocket.onmessage = function(event){
            if(event.data==="heartbeat") {
                console.log("heartbeat");
                webSocket.send("heartbeat");
                return;
            }
            var data = JSON.parse(event.data)
            var msg = data.msg;
            var nick = data.sendUserNickname;
            var userId = data.sendUserCookieId;
            switch(data.type){
                case 'init':
                    console.log("init");
                    break;
                case 'msg':
                    console.log("msg");
                    setMessageInnerHTML(nick, msg,userId,data.type,'');
                    break;
                case 'file':
                    console.log("file");
                    setMessageInnerHTML(nick, msg,userId,data.type,data.url);
                    break;
                case 'image':
                    console.log("image");
                    setMessageInnerHTML(nick, msg,userId,data.type,data.url);
                    break;
                default:
                    break;
            }

        }
    }
    setWebSocket();
    function reconnect(url) {
        if(wsConnect) return;
        //æ²¡è¿æ¥ä¸Šä¼šä¸€ç›´é‡è¿ï¼Œè®¾ç½®å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡å¤š
        webSocket = new WebSocket(url);
        wsConnect = true;
        setWebSocket();
        console.log("æ­£åœ¨é‡è¿ï¼Œå½“å‰æ—¶é—´" + new Date());
    }


    function enter(){
        var map = new Map();
        map.set("type","init");
        map.set("user",getCookie("user"));
        map.set("group",globalGroup);
        var message = Map2Json(map);
        webSocket.send(message);
    //    è·å–æœ€è¿‘100æ¡æ¶ˆæ¯
        if(!loadPreMsg) {
            loadPreMsg = true;

            $.ajax({
                url: '/group/getbelonggroup?uid='+getCookie("user"),
                success: function (json) {
                    $.each(json, function (i, item) {
                        //å¾ªç¯è·å–æ•°æ®
                        var nick = item.nickname;
                        var type = item.type;
                        var userId = item.groupFriendName;

                        $("#belong_group").last().append(' <li class="list-group-item">' +
                            '<button class="group-btn btn btn-inverse" onClick="reenter(this.id)" id='+userId+'>'+nick+'</button> </li>');
                    });
                }
            });


            $.ajax({
                url: '/textMsg/getLast100Msg',
                success: function (json) {
                    $.each(json, function (i, item) {
                        //å¾ªç¯è·å–æ•°æ®
                        var nick = item.nick_name;
                        var msg = item.msg;
                        var userId = item.idname;


                        var fileurl = "";
                        console.log(msg);
                        var msgArray = msg.split(MAGIC_FILE_SPLIT);
                        console.log("msgArray"+msgArray);
                        var fileprefix = msgArray[0];
                        if(msgArray.length==2) {
                            msg = msgArray[0];
                            fileurl = msgArray[1];
                            fileprefix = '<a href="/file?fileurl='+ fileurl+'" style="text-decoration:none; color:cadetblue;cursor:pointer; font-size:16px; padding-top:5px">'+
                                'ğŸ“„'+
                                msg+
                                '</a>';
                        } else {
                            msgArray = msg.split(MAGIC_IMAGE_SPLIT);
                            console.log("msgArray"+msgArray);
                            fileprefix = msgArray[0];
                            if(msgArray.length==2) {
                                msg = msgArray[0];
                                fileurl = msgArray[1];
                                fileprefix = '<img style="max-width: 350px; max-height: 250px"  src="/file?fileurl='+ fileurl+'">';
                            }

                        }
                        // <img style="max-width: 350px; max-height: 250px"  src="http://localhost:8080/file?fileurl=9bf8d31e39704668a8a5ced9092bae292876F0EA833EDA8DA415ADE79EDE1EA0.jpg">

                        console.log(fileprefix);
                        if(userId!=getCookie("user")){
                            // åˆ«äºº
                            $("#message").last().append('<li class="list-group-item"><span class="nickname">' +nick+
                                '</span><div class="msg"><div class="haha"><span>'+fileprefix+ '</span></div></div></li>');
                        }else {
                            // è‡ªå·±
                            $("#message").last().append('<li class="list-group-item">\n' +
                                '        <div style="float: right">\n' +
                                '            <span class="nickname" style="background: forestgreen;">' + nick +'</span>\n' +
                                '        </div>\n' +
                                '        <br />\n' +
                                '        <div class="msg" style="float: right"><div class="haha"><span> '+fileprefix+ '</span></div></div></li>');
                        }
                    });
                    items = document.querySelectorAll(".msg");
                    last = items[items.length-1];
                    last.scrollIntoView();
                }
            });
        }
    }

    function send() {
        var msg = document.getElementById('text').value;
        console.log("1:"+msg);
        if (msg != null && msg !== ""){
            var map = new Map();
            map.set("type","msg");
            map.set("user",getCookie("user"));
            map.set("group",globalGroup);
            map.set("msg",msg);
            var map2json=Map2Json(map);
            if (map2json.length < 8000){
                console.log("4:"+map2json);
                webSocket.send(map2json);
                document.getElementById('text').value='';
            }else {
                console.log("æ–‡æœ¬å¤ªé•¿äº†ï¼Œå°‘å†™ä¸€ç‚¹å§ğŸ˜­");
            }
        }
    }

    function getCookie(cookie_name) {
        var allcookies = document.cookie;
        //ç´¢å¼•é•¿åº¦ï¼Œå¼€å§‹ç´¢å¼•çš„ä½ç½®
        var cookie_pos = allcookies.indexOf(cookie_name);

        // å¦‚æœæ‰¾åˆ°äº†ç´¢å¼•ï¼Œå°±ä»£è¡¨cookieå­˜åœ¨,å¦åˆ™ä¸å­˜åœ¨
        if (cookie_pos != -1) {
            // æŠŠcookie_posæ”¾åœ¨å€¼çš„å¼€å§‹ï¼Œåªè¦ç»™å€¼åŠ 1å³å¯
            //è®¡ç®—å–cookieå€¼å¾—å¼€å§‹ç´¢å¼•ï¼ŒåŠ çš„1ä¸ºâ€œ=â€
            cookie_pos = cookie_pos + cookie_name.length + 1;
            //è®¡ç®—å–cookieå€¼å¾—ç»“æŸç´¢å¼•
            var cookie_end = allcookies.indexOf(";", cookie_pos);

            if (cookie_end == -1) {
                cookie_end = allcookies.length;

            }
            //å¾—åˆ°æƒ³è¦çš„cookieçš„å€¼
            var value = unescape(allcookies.substring(cookie_pos, cookie_end));
        }
        return value;
    }

    //å°†æ¶ˆæ¯æ˜¾ç¤ºåœ¨ç½‘é¡µä¸Š
    function setMessageInnerHTML(nick,msg,userId,type,url) {
        var fileprefix = msg;
        if(type==="file") {
            fileprefix = '<a href="/file?fileurl='+ url+'" style="text-decoration:none; color:cadetblue;cursor:pointer; font-size:16px; padding-top:5px">'+
                'ğŸ“„'+
            msg+
            '</a>';
        } else if(type==="image") {
            fileprefix = '<img style="max-width: 350px; max-height: 250px"  src="/file?fileurl='+ url+'">';
        }
        if(userId!=getCookie("user")){
            // åˆ«äºº
            $("#message").last().append('<li class="list-group-item"><span class="nickname">' +nick+
                '</span><div class="msg"><div class="haha"><span>'+fileprefix+ '</span></div></div></li>');
        }else {
            // è‡ªå·±
            $("#message").last().append('<li class="list-group-item">\n' +
                '        <div style="float: right">\n' +
                '            <span class="nickname" style="background: forestgreen;">' + nick +'</span>\n' +
                '        </div>\n' +
                '        <br />\n' +
                '        <div class="msg" style="float: right"><div class="haha"><span> '+fileprefix+ '</span></div></div></li>');
        }
        items = document.querySelectorAll(".msg");
        last = items[items.length-1];
        last.scrollIntoView();


    }

    function Map2Json(map) {
        var str = "{";
        map.forEach(function (value, key) {
            str += '"'+key+'"'+':'+ '"'+value+'",';
        })
        str = str.substring(0,str.length-1)
        str +="}";
        return str;
    }

    function reenter(groupid) {
        var x = document.getElementsByClassName("group-btn");
        var i;
        for (i = 0; i < x.length; i++) {
            x[i].style.backgroundColor = "";
        }
        document.getElementById(groupid).style.backgroundColor="skyblue";
        var map = new Map();
        map.set("type","init");
        map.set("user",getCookie("user"));
        map.set("group",groupid);
        var message = Map2Json(map);
        webSocket.send(message);
        //    è·å–æœ€è¿‘100æ¡æ¶ˆæ¯
        loadPreMsg = false;
        if(!loadPreMsg) {
            loadPreMsg = true;

            $.ajax({
                url: '/group/getLast100Msg?gid='+groupid,
                success: function (json) {
                    $("#cur_room_id").html("æˆ¿é—´å·ï¼š"+groupid);
                    $("#message").html(' ');
                    globalGroup = groupid;
                    $.each(json, function (i, item) {
                        //å¾ªç¯è·å–æ•°æ®
                        var nick = item.nick_name;
                        var msg = item.msg;
                        var userId = item.idname;


                        var fileurl = "";
                        console.log(msg);
                        var msgArray = msg.split(MAGIC_FILE_SPLIT);
                        console.log("msgArray"+msgArray);
                        var fileprefix = msgArray[0];
                        if(msgArray.length===2) {
                            msg = msgArray[0];
                            fileurl = msgArray[1];
                            fileprefix = '<a href="/file?fileurl='+ fileurl+'" style="text-decoration:none; color:cadetblue;cursor:pointer; font-size:16px; padding-top:5px">'+
                                'ğŸ“„'+
                                msg+
                                '</a>';
                        } else {
                            msgArray = msg.split(MAGIC_IMAGE_SPLIT);
                            console.log("msgArray"+msgArray);
                            fileprefix = msgArray[0];
                            if(msgArray.length===2) {
                                msg = msgArray[0];
                                fileurl = msgArray[1];
                                fileprefix = '<img style="max-width: 350px; max-height: 250px"  src="/file?fileurl='+ fileurl+'">';
                            }
                        }



                        console.log(fileprefix);
                        if(userId!=getCookie("user")){
                            // åˆ«äºº
                            $("#message").last().append('<li class="list-group-item"><span class="nickname">' +nick+
                                '</span><div class="msg"><div class="haha"><span>'+fileprefix+ '</span></div></div></li>');
                        }else {
                            // è‡ªå·±
                            $("#message").last().append('<li class="list-group-item">\n' +
                                '        <div style="float: right">\n' +
                                '            <span class="nickname" style="background: forestgreen;">' + nick +'</span>\n' +
                                '        </div>\n' +
                                '        <br />\n' +
                                '        <div class="msg" style="float: right"><div class="haha"><span> '+fileprefix+ '</span></div></div></li>');
                        }
                    });
                    items = document.querySelectorAll(".msg");
                    last = items[items.length-1];
                    last.scrollIntoView();
                }
            });
        }
    }
</script>
<!--!&#45;&#45; jQueryæ–‡ä»¶ã€‚åŠ¡å¿…åœ¨bootstrap.min.js ä¹‹å‰å¼•å…¥ -->
<script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"/>
<!-- æœ€æ–°çš„ Bootstrap æ ¸å¿ƒ JavaScript æ–‡ä»¶ -->
<script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"/>
</body>
</html>