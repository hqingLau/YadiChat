<!DOCTYPE HTML>
<html xmlns:resize="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>å…¨å±€èŠå¤©å®¤</title>
    <!-- å¼•å…¥ Bootstrap -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.js"></script>
</head>
<body>
<div class="page-header text-center text-primary">
    <h1>å…¨å±€èŠå¤©å®¤</h1>
</div>

<br /><br />
<!--<div id="message"></div>-->
<ul class="list-group" id="message">
    <li class="list-group-item" >æ¬¢è¿å…¥ç¾¤</li>
</ul>
<br /><br />


<div>
    <button class="btn btn-primary" style="float: right;margin-right: 10px" type="button" onclick="send()">å‘é€</button>
    <div style="overflow: hidden; padding-right: 10px">
    <textarea style="margin-left:10px;width: 100%; resize: none"
           id="text"
           name="send"
           placeholder="è¾“å…¥å‘é€æ¶ˆæ¯"
           rows="1"
           autofocus="autofocus"
           maxlength="1000"
           minlength="1"
           class="form-control"></textarea>
    </div>
    <div class="clear"></div>
</div>

<script type="text/javascript">
    var webSocket;

    if (window.WebSocket) {
        webSocket = new WebSocket("ws://localhost:10240/ws");
    } else {
        alert("æŠ±æ­‰ï¼Œæ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒWebSocketåè®®!");
    }

    //è¿é€šä¹‹åçš„å›è°ƒäº‹ä»¶
    webSocket.onopen = function() {
        console.log("å·²ç»è¿é€šäº†websocket");
        enter();
    };
    //è¿æ¥å‘ç”Ÿé”™è¯¯çš„å›è°ƒæ–¹æ³•
    webSocket.onerror = function(event){
        console.log("å‡ºé”™äº†");
//              setMessageInnerHTML("è¿æ¥å¤±è´¥");
    };

    //è¿æ¥å…³é—­çš„å›è°ƒæ–¹æ³•
    webSocket.onclose = function(){
        console.log("è¿æ¥å·²å…³é—­...");

    }

    //æ¥æ”¶åˆ°æ¶ˆæ¯çš„å›è°ƒæ–¹æ³•
    webSocket.onmessage = function(event){
        var data = JSON.parse(event.data)
        var msg = data.msg;
        var nick = data.sendUserNickname;
        switch(data.type){
            case 'init':
                console.log("init");
                break;
            case 'msg':
                console.log("msg");
                setMessageInnerHTML(nick+":  "+msg);
                break;
            default:
                break;
        }
    }
    function enter(){
        var map = new Map();
        map.set("type","init");
        map.set("user",getCookie("user"));
        var message = Map2Json(map);
        webSocket.send(message);
    }

    function send() {
        var msg = document.getElementById('text').value;
        console.log("1:"+msg);
        if (msg != null && msg !== ""){
            var map = new Map();
            map.set("type","msg");
            map.set("user",getCookie("user"));
            map.set("msg",msg);
            var map2json=Map2Json(map);
            if (map2json.length < 8000){
                console.log("4:"+map2json);
                webSocket.send(map2json);
            }else {
                console.log("æ–‡æœ¬å¤ªé•¿äº†ï¼Œå°‘å†™ä¸€ç‚¹å§ğŸ˜­");
            }
        }
    }

    function getCookie(cookie_name) {
        var allcookies = document.cookie;
        //ç´¢å¼•é•¿åº¦ï¼Œå¼€å§‹ç´¢å¼•çš„ä½ç½®
        var cookie_pos = allcookies.indexOf(cookie_name);

        // å¦‚æœæ‰¾åˆ°äº†ç´¢å¼•ï¼Œå°±ä»£è¡¨cookieå­˜åœ¨,å¦åˆ™ä¸å­˜åœ¨
        if (cookie_pos != -1) {
            // æŠŠcookie_posæ”¾åœ¨å€¼çš„å¼€å§‹ï¼Œåªè¦ç»™å€¼åŠ 1å³å¯
            //è®¡ç®—å–cookieå€¼å¾—å¼€å§‹ç´¢å¼•ï¼ŒåŠ çš„1ä¸ºâ€œ=â€
            cookie_pos = cookie_pos + cookie_name.length + 1;
            //è®¡ç®—å–cookieå€¼å¾—ç»“æŸç´¢å¼•
            var cookie_end = allcookies.indexOf(";", cookie_pos);

            if (cookie_end == -1) {
                cookie_end = allcookies.length;

            }
            //å¾—åˆ°æƒ³è¦çš„cookieçš„å€¼
            var value = unescape(allcookies.substring(cookie_pos, cookie_end));
        }
        return value;
    }

    //å°†æ¶ˆæ¯æ˜¾ç¤ºåœ¨ç½‘é¡µä¸Š
    function setMessageInnerHTML(innerHTML) {
        $("#message").last().append('<li class="list-group-item">' +innerHTML+'</li>');
    }

    function Map2Json(map) {
        var str = "{";
        map.forEach(function (value, key) {
            str += '"'+key+'"'+':'+ '"'+value+'",';
        })
        str = str.substring(0,str.length-1)
        str +="}";
        return str;
    }

</script>
<!--!&#45;&#45; jQueryæ–‡ä»¶ã€‚åŠ¡å¿…åœ¨bootstrap.min.js ä¹‹å‰å¼•å…¥ -->
<script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"/>
<!-- æœ€æ–°çš„ Bootstrap æ ¸å¿ƒ JavaScript æ–‡ä»¶ -->
<script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"/>
</body>
</html>